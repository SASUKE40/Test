<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <title>进口周首页动画</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-touch-fullscreen" content="yes">
  <meta name="format-detection" content="telephone=no, email=no">
  <link href="//g.alicdn.com/mui/global/1.2.35/file/favicon.ico" rel="shortcut icon" type="image/x-icon">
  <script src="//g.alicdn.com/mtb/lib-flexible/0.3.2/flexible.js"></script>
  <script src="//g.alicdn.com/mtb/??lib-windvane/2.0.3/windvane.js,lib-mtop/1.6.4/mtop.js,lib-login/1.4.1/login.js,lib-env/1.5.0/env.js,lib-aa/0.0.16/aa.js,lib-httpurl/1.3.2/httpurl.js,lib-img/0.2.6/img.js,lib-lazyload/2.1.2/lazyload.js,lib-motion/1.0.5/motion.js,lib-gesture/1.1.11/gesture.js,"></script>
  <style>
  html,
  body {
    position: absolute;
    height: 100%;
    width: 100%;
    margin: 0;
    overflow: hidden;
    /*background: rgba(0, 0, 0, .2);*/
  }

  ul {
    padding: 0;
    margin: 0;
  }
  /* 使用REM方案来定位icon的位置，有问题询问@似零 */

  .mui-icon-container {
    /*background: rgba(255,0,0,.3);*/
    width: 10rem;
  }

  .mui-icon-container img {
    display: block;
    width: 1.8rem;
    margin: 0px auto;
  }

  .mui-flex {
    display: -webkit-box!important;
    display: -webkit-flex!important;
    display: -ms-flexbox!important;
    display: flex!important;
    -webkit-flex-wrap: wrap;
    -ms-flex-wrap: wrap;
    flex-wrap: wrap;
    box-sizing: border-box;
    height: 2rem;
  }

  .mui-flex>.cell {
    -webkit-box-flex: 1;
    -webkit-flex: 1;
    -ms-flex: 1;
    flex: 1;
    -webkit-flex-basis: 0;
    -ms-flex-preferred-size: 0;
    flex-basis: 0;
    max-width: 100%;
    display: block;
    padding: 0!important;
    position: relative;
    box-sizing: border-box;
    z-index: 9999;
    width: 2rem;
    margin-top: 0.14rem;
  }

  .hidden {
    visibility: hidden;
  }
  /* 设定目标点的宽高 */

  #target {
    width: 1.9rem;
    height: 2rem;
  }
  /* 国旗缩放动画 */

  @-webkit-keyframes flag {
    25% {
      width: 1.8rem;
    }
    100% {
      width: .3rem;
    }
  }

  @keyframes flag {
    25% {
      width: 1.8rem;
    }
    100% {
      width: .3rem;
    }
  }
  /* iOS和Android视图高度不同，iOS要比Android高出约0.5rem */

  .IOS .mui-flex {
    height: 2.25rem;
  }

  .ANDROID .mui-flex {
    height: 1.9rem;
  }

  .ANDROID .mui-icon-container {
    padding-top: 4px;
  }
  </style>
</head>

<body>
  <script type="text/javascript">
  // 操作系统判断，如果是iOS则给body加上'IOS'，如果是Android则给加上'ANDROID'
  document.body.classList.add(lib.env.os.isIOS ? 'IOS' : 'ANDROID')
  </script>
  <!-- 首页icon容器 -->
  <div class="mui-icon-container hidden">
    <ul class="mui-flex">
      <li class="cell">
        <img class="element" src="//img.alicdn.com/tps/TB1WL_dJVXXXXcTXXXXXXXXXXXX-183-129.png">
      </li>
      <li class="cell">
        <img class="element" src="//img.alicdn.com/tps/TB1keyNJVXXXXXCaXXXXXXXXXXX-183-129.png">
      </li>
      <li class="cell">
        <div id="target"></div>
      </li>
      <li class="cell">
        <img class="element" src="//img.alicdn.com/tps/TB1YM6fJVXXXXa8XXXXXXXXXXXX-183-129.png">
      </li>
      <li class="cell">
        <img class="element" src="//img.alicdn.com/tps/TB1vMbXJVXXXXa3XpXXXXXXXXXX-183-129.png">
      </li>
    </ul>
    <ul class="mui-flex">
      <li class="cell">
        <img class="element" src="//img.alicdn.com/tps/TB1UMy2JVXXXXbvXFXXXXXXXXXX-183-129.png">
      </li>
      <li class="cell">
        <img class="element" src="//img.alicdn.com/tps/TB1cJa1JVXXXXczXFXXXXXXXXXX-183-129.png">
      </li>
      <li class="cell">
        <img class="element" src="//img.alicdn.com/tps/TB1aqa1JVXXXXbPXFXXXXXXXXXX-183-129.png">
      </li>
      <li class="cell">
        <img class="element" src="//img.alicdn.com/tps/TB1oK9NJVXXXXX3aXXXXXXXXXXX-183-129.png">
      </li>
      <li class="cell">
        <img class="element" src="//img.alicdn.com/tps/TB1WKuWJVXXXXX5XVXXXXXXXXXX-183-129.png">
      </li>
    </ul>
  </div>
  <!-- 首页icon容器 End -->
  <script type="text/javascript">
  /*
   * Tween.js
   * t: current time（当前时间）；
   * b: beginning value（初始值）；
   * c: change in value（变化量）；
   * d: duration（持续时间）。
   * you can visit 'http://easings.net/zh-cn' to get effect
   */
  var Tween = {
    Linear: function(t, b, c, d) {
      return c * t / d + b
    },
    Quad: {
      easeIn: function(t, b, c, d) {
        return c * (t /= d) * t + b
      },
      easeOut: function(t, b, c, d) {
        return -c * (t /= d) * (t - 2) + b
      },
      easeInOut: function(t, b, c, d) {
        if ((t /= d / 2) < 1) return c / 2 * t * t + b
        return -c / 2 * ((--t) * (t - 2) - 1) + b
      }
    },
    Cubic: {
      easeIn: function(t, b, c, d) {
        return c * (t /= d) * t * t + b
      },
      easeOut: function(t, b, c, d) {
        return c * ((t = t / d - 1) * t * t + 1) + b
      },
      easeInOut: function(t, b, c, d) {
        if ((t /= d / 2) < 1) return c / 2 * t * t * t + b
        return c / 2 * ((t -= 2) * t * t + 2) + b
      }
    },
    Quart: {
      easeIn: function(t, b, c, d) {
        return c * (t /= d) * t * t * t + b
      },
      easeOut: function(t, b, c, d) {
        return -c * ((t = t / d - 1) * t * t * t - 1) + b
      },
      easeInOut: function(t, b, c, d) {
        if ((t /= d / 2) < 1) return c / 2 * t * t * t * t + b
        return -c / 2 * ((t -= 2) * t * t * t - 2) + b
      }
    },
    Quint: {
      easeIn: function(t, b, c, d) {
        return c * (t /= d) * t * t * t * t + b
      },
      easeOut: function(t, b, c, d) {
        return c * ((t = t / d - 1) * t * t * t * t + 1) + b
      },
      easeInOut: function(t, b, c, d) {
        if ((t /= d / 2) < 1) return c / 2 * t * t * t * t * t + b
        return c / 2 * ((t -= 2) * t * t * t * t + 2) + b
      }
    },
    Sine: {
      easeIn: function(t, b, c, d) {
        return -c * Math.cos(t / d * (Math.PI / 2)) + c + b
      },
      easeOut: function(t, b, c, d) {
        return c * Math.sin(t / d * (Math.PI / 2)) + b
      },
      easeInOut: function(t, b, c, d) {
        return -c / 2 * (Math.cos(Math.PI * t / d) - 1) + b
      }
    },
    Expo: {
      easeIn: function(t, b, c, d) {
        return (t == 0) ? b : c * Math.pow(2, 10 * (t / d - 1)) + b
      },
      easeOut: function(t, b, c, d) {
        return (t == d) ? b + c : c * (-Math.pow(2, -10 * t / d) + 1) + b
      },
      easeInOut: function(t, b, c, d) {
        if (t == 0) return b
        if (t == d) return b + c
        if ((t /= d / 2) < 1) return c / 2 * Math.pow(2, 10 * (t - 1)) + b
        return c / 2 * (-Math.pow(2, -10 * --t) + 2) + b
      }
    },
    Circ: {
      easeIn: function(t, b, c, d) {
        return -c * (Math.sqrt(1 - (t /= d) * t) - 1) + b
      },
      easeOut: function(t, b, c, d) {
        return c * Math.sqrt(1 - (t = t / d - 1) * t) + b
      },
      easeInOut: function(t, b, c, d) {
        if ((t /= d / 2) < 1) return -c / 2 * (Math.sqrt(1 - t * t) - 1) + b
        return c / 2 * (Math.sqrt(1 - (t -= 2) * t) + 1) + b
      }
    },
    Elastic: {
      easeIn: function(t, b, c, d, a, p) {
        var s
        if (t == 0) return b
        if ((t /= d) == 1) return b + c
        if (typeof p == "undefined") p = d * .3
        if (!a || a < Math.abs(c)) {
          s = p / 4
          a = c
        } else {
          s = p / (2 * Math.PI) * Math.asin(c / a)
        }
        return -(a * Math.pow(2, 10 * (t -= 1)) * Math.sin((t * d - s) * (2 * Math.PI) / p)) + b
      },
      easeOut: function(t, b, c, d, a, p) {
        var s
        if (t == 0) return b
        if ((t /= d) == 1) return b + c
        if (typeof p == "undefined") p = d * .3
        if (!a || a < Math.abs(c)) {
          a = c
          s = p / 4
        } else {
          s = p / (2 * Math.PI) * Math.asin(c / a)
        }
        return (a * Math.pow(2, -10 * t) * Math.sin((t * d - s) * (2 * Math.PI) / p) + c + b)
      },
      easeInOut: function(t, b, c, d, a, p) {
        var s
        if (t == 0) return b
        if ((t /= d / 2) == 2) return b + c
        if (typeof p == "undefined") p = d * (.3 * 1.5)
        if (!a || a < Math.abs(c)) {
          a = c
          s = p / 4
        } else {
          s = p / (2 * Math.PI) * Math.asin(c / a)
        }
        if (t < 1) return -.5 * (a * Math.pow(2, 10 * (t -= 1)) * Math.sin((t * d - s) * (2 * Math.PI) / p)) + b
        return a * Math.pow(2, -10 * (t -= 1)) * Math.sin((t * d - s) * (2 * Math.PI) / p) * .5 + c + b
      }
    },
    Back: {
      easeIn: function(t, b, c, d, s) {
        if (typeof s == "undefined") s = 1.70158
        return c * (t /= d) * t * ((s + 1) * t - s) + b
      },
      easeOut: function(t, b, c, d, s) {
        if (typeof s == "undefined") s = 1.70158
        return c * ((t = t / d - 1) * t * ((s + 1) * t + s) + 1) + b
      },
      easeInOut: function(t, b, c, d, s) {
        if (typeof s == "undefined") s = 1.70158
        if ((t /= d / 2) < 1) return c / 2 * (t * t * (((s *= (1.525)) + 1) * t - s)) + b
        return c / 2 * ((t -= 2) * t * (((s *= (1.525)) + 1) * t + s) + 2) + b
      }
    },
    Bounce: {
      easeIn: function(t, b, c, d) {
        return c - Tween.Bounce.easeOut(d - t, 0, c, d) + b
      },
      easeOut: function(t, b, c, d) {
        if ((t /= d) < (1 / 2.75)) {
          return c * (7.5625 * t * t) + b
        } else if (t < (2 / 2.75)) {
          return c * (7.5625 * (t -= (1.5 / 2.75)) * t + .75) + b
        } else if (t < (2.5 / 2.75)) {
          return c * (7.5625 * (t -= (2.25 / 2.75)) * t + .9375) + b
        } else {
          return c * (7.5625 * (t -= (2.625 / 2.75)) * t + .984375) + b
        }
      },
      easeInOut: function(t, b, c, d) {
        if (t < d / 2) {
          return Tween.Bounce.easeIn(t * 2, 0, c, d) * .5 + b
        } else {
          return Tween.Bounce.easeOut(t * 2 - d, 0, c, d) * .5 + c * .5 + b
        }
      }
    }
  }
  Math.tween = Tween
  </script>
  <script type="text/javascript">
  var funParabola = function(element, target, options) {
      /*
       * 网页模拟现实需要一个比例尺
       * 如果按照1像素就是1米来算，显然不合适，因为页面动不动就几百像素
       * 页面上，我们放两个物体，200~800像素之间，我们可以映射为现实世界的2米到8米，也就是100:1
       * 不过，本方法没有对此有所体现，因此不必在意
       */

      var defaults = {
        speed: 2400, // 每帧移动的像素大小，每帧（对于大部分显示屏）大约16~17毫秒
        curvature: 0, // 实际指焦点到准线的距离，你可以抽象成曲率，这里模拟扔物体的抛物线，因此是开口向下的
        progress: function() {},
        complete: function() {}
      }

      var params = {}
      options = options || {}

      for (var key in defaults) {
        params[key] = options[key] || defaults[key]
      }

      var exports = {
        mark: function() {
          return this
        },
        position: function() {
          return this
        },
        move: function() {
          return this
        },
        init: function() {
          return this
        }
      }

      /* 确定移动的方式
       * IE6-IE8 是margin位移
       * IE9+使用transform
       */
      var moveStyle = "margin",
        testDiv = document.createElement("div")
      if ("oninput" in testDiv) {
        ["", "ms", "webkit"].forEach(function(prefix) {
          var transform = prefix + (prefix ? "T" : "t") + "ransform"
          if (transform in testDiv.style) {
            moveStyle = transform
          }
        })
      }

      // 根据两点坐标以及曲率确定运动曲线函数（也就是确定a, b的值）
      /* 公式： y = a*x*x + b*x + c;
       */
      var a = params.curvature,
        b = 0,
        c = 0

      // 是否执行运动的标志量
      var flagMove = true
      var startTime = Date.now()

      if (element && target && element.nodeType == 1 && target.nodeType == 1) {
        var rectElement = {},
          rectTarget = {}

        // 移动元素的中心点位置，目标元素的中心点位置
        var centerElement = {},
          centerTarget = {}

        // 目标元素的坐标位置
        var coordElement = {},
          coordTarget = {}

        // 标注当前元素的坐标
        exports.mark = function() {
          if (flagMove == false) return this
          if (typeof coordElement.x == "undefined") this.position()
          element.setAttribute("data-center", [coordElement.x, coordElement.y].join())
          target.setAttribute("data-center", [coordTarget.x, coordTarget.y].join())
          return this
        }

        exports.position = function() {
          if (flagMove == false) return this

          var scrollLeft = document.documentElement.scrollLeft || document.body.scrollLeft,
            scrollTop = document.documentElement.scrollTop || document.body.scrollTop

          // 初始位置
          if (moveStyle == "margin") {
            element.style.marginLeft = element.style.marginTop = "0px"
          } else {
            element.style[moveStyle] = "translate(0, 0)"
          }

          // 四边缘的坐标
          rectElement = element.getBoundingClientRect()
          rectTarget = target.getBoundingClientRect()

          // 移动元素的中心点坐标
          centerElement = {
            x: rectElement.left + (rectElement.right - rectElement.left) / 2 + scrollLeft,
            y: rectElement.top + (rectElement.bottom - rectElement.top) / 2 + scrollTop
          }

          // 目标元素的中心点位置
          centerTarget = {
            x: rectTarget.left + (rectTarget.right - rectTarget.left) / 2 + scrollLeft,
            y: rectTarget.top + (rectTarget.bottom - rectTarget.top) / 2 + scrollTop
          }

          // 转换成相对坐标位置
          coordElement = {
            x: 0,
            y: 0
          }
          coordTarget = {
            x: -1 * (centerElement.x - centerTarget.x),
            y: -1 * (centerElement.y - centerTarget.y)
          }

          /*
           * 因为经过(0, 0), 因此c = 0
           * 于是：
           * y = a * x*x + b*x;
           * y1 = a * x1*x1 + b*x1;
           * y2 = a * x2*x2 + b*x2;
           * 利用第二个坐标：
           * b = (y2+ a*x2*x2) / x2
           */
          // 于是
          b = (coordTarget.y - a * coordTarget.x * coordTarget.x) / coordTarget.x

          return this
        }

        // 按照这个曲线运动
        exports.move = function(callback) {
          // 如果曲线运动还没有结束，不再执行新的运动
          if (flagMove == false) return this
          var startx = 0,
            rate = coordTarget.x > 0 ? 1 : -1
          var now = new Date().getTime()
          var step = function() {
            // 切线 y'=2ax+b
            var tangent = 2 * a * startx + b // = y / x
              // y*y + x*x = speed
              // (tangent * x)^2 + x*x = speed
              // x = Math.sqr(speed / (tangent * tangent + 1));
              // startx = startx + rate * Math.sqrt(params.speed / (tangent * tangent + 1));
            var time = new Date().getTime() - now
            startx = Tween.Cubic.easeIn(time, startx, rate * Math.sqrt(params.speed / (tangent * tangent + 1)), 1667)
              // debugger

            // 防止过界
            if ((rate == 1 && startx > coordTarget.x) || (rate == -1 && startx < coordTarget.x)) {
              startx = coordTarget.x
            }
            var x = startx,
              y = a * x * x + b * x

            // 标记当前位置，这里有测试使用的嫌疑，实际使用可以将这一行注释
            element.setAttribute("data-center", [Math.round(x), Math.round(y)].join())

            // x, y目前是坐标，需要转换成定位的像素值
            if (moveStyle == "margin") {
              element.style.marginLeft = x + "px"
              element.style.marginTop = y + "px"
            } else {
              element.style[moveStyle] = "translate(" + [x + "px", y + "px"].join() + ")"
            }

            if (startx !== coordTarget.x) {
              params.progress(x, y)
              window.requestAnimationFrame(step)
            } else {
              // 运动结束，回调执行
              params.complete()
              flagMove = true
              callback()
            }
          }
          window.requestAnimationFrame(step)
          flagMove = false

          return this
        }

        // 初始化方法
        exports.init = function(callback) {
          this.position().mark().move(callback)
        }
      }

      return exports
    }
    /**
     * RequestAnimationFrame Polyfill
     * @author shilin.zsl <shilin.zsl@alibaba-inc.com>
     * @date   2016-05-19
     * @param  {[type]}   function( [description]
     * @return {[type]}             [description]
     */
  ;
  (function() {
    var lastTime = 0
    var vendors = ['webkit', 'moz']
    for (var x = 0; x < vendors.length && !window.requestAnimationFrame; ++x) {
      window.requestAnimationFrame = window[vendors[x] + 'RequestAnimationFrame']
      window.cancelAnimationFrame = window[vendors[x] + 'CancelAnimationFrame'] || // name has changed in Webkit
        window[vendors[x] + 'CancelRequestAnimationFrame']
    }

    if (!window.requestAnimationFrame) {
      window.requestAnimationFrame = function(callback, element) {
        var currTime = new Date().getTime()
        var timeToCall = Math.max(0, 16.7 - (currTime - lastTime))
        var id = window.setTimeout(function() {
          callback(currTime + timeToCall)
        }, timeToCall)
        lastTime = currTime + timeToCall
        return id
      }
    }
    if (!window.cancelAnimationFrame) {
      window.cancelAnimationFrame = function(id) {
        clearTimeout(id)
      }
    }
  }())
  </script>
  <script>
  // 首页icon视图组件区域，Android里面要从天猫国际icon向上寻找三级才能找到视图区域组件
  var block = lib.env.os.isIOS ? "TBHomeGridView" : "android.support.v7.widget.AppCompatTextView[text=天猫国际]<<<"
    // 起点icon的ViewId，根据平台不同要用不同的描述定位方式，在iOS中使用ObjectC，在Android使用Java包名，Android中有点不同，需要从TextView向上寻找一级
  var start = lib.env.os.isIOS ? "UIImageView[accessibilityLabel=天猫国际]" : "android.support.v7.widget.AppCompatTextView[text=天猫国际]<"

  // 飞机出现图
  var planeImg = '//img.alicdn.com/tps/TB1BLDiJVXXXXaeaXXXXXXXXXXX-183-174.gif'
    // 飞机消失返回图
  var planeBackImg = '//img.alicdn.com/tps/TB1uYbOJVXXXXbRXXXXXXXXXXXX-183-174.gif'

  // 1x1 空白gif
  var blankImg = '//gw.alicdn.com/mt/TB19X9vJVXXXXXoXXXXXXXXXXXX-1-1.gif'

  // 国旗图
  var flagImg = [
    '//img.alicdn.com/tps/TB1keyNJVXXXXXCaXXXXXXXXXXX-183-129.png',
    '//img.alicdn.com/tps/TB1WL_dJVXXXXcTXXXXXXXXXXXX-183-129.png',
    '//img.alicdn.com/tps/TB1UMy2JVXXXXbvXFXXXXXXXXXX-183-129.png',
    '//img.alicdn.com/tps/TB1cJa1JVXXXXczXFXXXXXXXXXX-183-129.png',
    '//img.alicdn.com/tps/TB1aqa1JVXXXXbPXFXXXXXXXXXX-183-129.png',
    '//img.alicdn.com/tps/TB1oK9NJVXXXXX3aXXXXXXXXXXX-183-129.png',
    '//img.alicdn.com/tps/TB1WKuWJVXXXXX5XVXXXXXXXXXX-183-129.png',
    '//img.alicdn.com/tps/TB1vMbXJVXXXXa3XpXXXXXXXXXX-183-129.png',
    '//img.alicdn.com/tps/TB1YM6fJVXXXXa8XXXXXXXXXXXX-183-129.png'
  ].reverse()

  // icon组件的ViewId
  var icons = function() {
    return lib.env.os.isIOS ? [
      "UIImageView[accessibilityLabel=聚划算]",
      "UIImageView[accessibilityLabel=天猫]",
      "UIImageView[accessibilityLabel=充值中心]",
      "UIImageView[accessibilityLabel=阿里旅行]",
      "UIImageView[accessibilityLabel=领金币]",
      "UIImageView[accessibilityLabel=到家]",
      "UIImageView[accessibilityLabel=分类]",
      "UIImageView[accessibilityLabel=天猫超市]",
      "UIImageView[accessibilityLabel=外卖]"
    ] : [
      "android.support.v7.widget.AppCompatTextView[text=聚划算]<",
      "android.support.v7.widget.AppCompatTextView[text=天猫]<",
      "android.support.v7.widget.AppCompatTextView[text=充值中心]<",
      "android.support.v7.widget.AppCompatTextView[text=阿里旅行]<",
      "android.support.v7.widget.AppCompatTextView[text=领金币]<",
      "android.support.v7.widget.AppCompatTextView[text=到家]<",
      "android.support.v7.widget.AppCompatTextView[text=分类]<",
      "android.support.v7.widget.AppCompatTextView[text=天猫超市]<",
      "android.support.v7.widget.AppCompatTextView[text=外卖]<"
    ]
  }()
  icons.reverse()

  /**
   * Poplayer操作类，封装了WindVane的API
   * @type {Object}
   */
  PoplayerOperator = {
    /**
     * 跟踪布局，视图Id从HomeSearchView寻找
     * @author shilin.zsl <shilin.zsl@alibaba-inc.com>
     * @date   2016-05-19
     * @param  {String}   sel      目标元素ViewId
     * @param  {Function} callback 跟踪完成回调
     * @return {[type]}            [description]
     */
    trackLayout: function(sel, callback) {
      var me = this
      var mainParams = [{
        selector: sel,
        continuousSelect: true,
        groupId: 'icons',
        operation: {
          name: "poplayerTrack",
          params: {}
        }
      }]
      if (lib.env.os.isAndroid) {
        mainParams.push({
          selector: "com.taobao.tao.homepage.component.HomeSearchView[id=com.taobao.taobao:id/home_search_view]",
          groupId: "top",
          operation: {
            name: "mirror"
          }
        })
      }
      // 使用selectAndOperate操作参数来定位布局
      WindVane.call("WVPopLayer", "selectAndOperate", {
        mainParams: mainParams
      }, function(e) {
        callback()
      }, function(e) {})
    },
    /**
     * 获取元素大小
     * @author shilin.zsl <shilin.zsl@alibaba-inc.com>
     * @date   2016-05-19
     * @param  {String}   view     目标元素ViewId
     * @param  {Function} callback 获取元素大小执行回调
     * @return {[type]}            [description]
     */
    getItemSize: function(view, callback) {
      var me = this
      var id = me.id++
        if (!me.infos) {
          me.infos = {}
        }
      me.infos[view + "_" + id] = callback
      WindVane.call("WVPopLayer", "selectAndOperate", {
        mainParams: [{
          selector: view,
          taskHandle: view + "_" + id,
          continuousSelect: false,
          operation: {
            name: 'info'
          }
        }]
      }, function() {}, function(e) {
        // alert(JSON.stringify(e))
      })
    },
    /**
     * 私有方法，从infos队列中根据taskId将元素坐标、大小取出
     * @author shilin.zsl <shilin.zsl@alibaba-inc.com>
     * @date   2016-05-19
     * @param  {Object}   e 任务句柄
     * @return {[type]}     [description]
     */
    __info: function(e) {
      var me = this
      var taskId = e.param.taskHandle
      var fn = me.infos[taskId]
      if (fn) {
        if (e.param.succeed) {
          fn(e.param.info)
        } else {
          fn({})
        }
        delete me.infos[taskId]
      }
    },
    id: 100,
    /**
     * 监听PopLayer跟踪事件
     * @author shilin.zsl <shilin.zsl@alibaba-inc.com>
     * @date   2016-05-19
     * @return {[type]}   [description]
     */
    listen: function() {
      var me = this
      document.addEventListener("PopLayer.SOTask.Track", function(e) {
        //alert("Error" + JSON.stringify(e))
      }, false)
      document.addEventListener("PopLayer.SOTask.Info", function(e) {
        //document.write(JSON.stringify(e))
        me.__info(e)
      }, false)
    },
    /**
     * 显示PopLayer
     * @author shilin.zsl <shilin.zsl@alibaba-inc.com>
     * @date   2016-05-19
     * @return {[type]}   [description]
     */
    display: function() {
      window.WindVane.call('WVPopLayer', 'display', {},
        function(s) {},
        function(e) {})
    },
    /**
     * 跟踪并替换图片
     * @author shilin.zsl <shilin.zsl@alibaba-inc.com>
     * @date   2016-05-19
     * @param  {String}   sel    目标元素ViewId
     * @param  {String}   imgUrl 图片url
     * @return {[type]}          [description]
     */
    track: function(sel, imgUrl) {
      if (lib.env.os.isIOS) {
        var mainParams = [{
          selector: sel,
          operation: {
            name: imgUrl.length ? 'track' : "untrack",
            params: {
              imgUrl: imgUrl,
              modalThreshold: 0,
              imgFillMode: "ScaleAspectFit"
            }
          }
        }]
        WindVane.call("WVPopLayer", "selectAndOperate", {
          mainParams: mainParams
        })
      } else {
        if (imgUrl.length) {
          PoplayerOperator.trackDom(sel, imgUrl)
        }
      }
    },
    /**
     * 在元素上覆盖图片
     * @author shilin.zsl <shilin.zsl@alibaba-inc.com>
     * @date   2016-05-19
     * @param  {String}   sel    目标元素ViewId
     * @param  {String}   imgUrl 图片url
     * @param  {Function} callback 渲染元素执行回调
     * @return {[type]}            [description]
     */
    renderDom: function(sel, imgUrl, callback) {
      var me = this
      me.getItemSize(sel, function(e) {
        if (typeof e === 'string') {
          e = JSON.parse(e)
        }
        // 如果超出视野范围就关闭动画
        if (typeof e.height === 'undefined') {
          window.WindVane.call('WVPopLayer', 'close', {})
        }

        var blockData = me.trackData.block
        var selData = me.trackData[sel]
        var cp = me.trackData.cp
          // top 自己算
        var top = function() {
          var baseTop = 8.3 * (selData.width / 44) * cp
          var index = icons.indexOf(sel)
            // 如果是第一排 icon
          if (index === 0 || index > 5) {
            return baseTop
          }
          // 如果不在 icons 里，就是 start
          else if (index === -1)
            return baseTop
              // 如果是第二排 icon
          else {
            //alert( baseTop + "\t" + selData.height * cp )
            return 14.6 * (selData.width / 44) * cp + selData.height * cp
          }
        }()

        var div = document.createElement('div')
        div.style.cssText = [
          'position: absolute',
          'z-index:' + (me.id++),
          'height:' + (selData.height * cp) + 'px',
          'width:' + (selData.width * cp) + 'px',
          'left:' + ((selData.x - blockData.x) * cp) + 'px',
          // 'top:' + ((selData.y - blockData.y) * cp) + 'px'
          'top:' + (top) + 'px'
        ].join(';')
        div.innerHTML = '<img src="' + imgUrl + '" width="100%">'
        document.body.appendChild(div)
        if (callback) {
          callback(div)
        }
      })
    },
    /**
     * 渲染飞机图
     * @author shilin.zsl <shilin.zsl@alibaba-inc.com>
     * @date   2016-05-19
     * @param  {String}   sel      飞机显示位置的ViewId
     * @param  {String}   imgUrl   飞机图片url
     * @param  {Function} callback 渲染完成回调
     * @return {[type]}            [description]
     */
    renderPlane: function(sel, imgUrl, callback) {
      var me = this
      me.getItemSize(sel, function(e) {
        if (typeof e === 'string') {
          e = JSON.parse(e)
        }
        // 如果超出视野范围就关闭动画
        if (typeof e.height === 'undefined') {
          window.WindVane.call('WVPopLayer', 'close', {})
        }

        var blockData = me.trackData.block
        var selData = me.trackData[sel]
        var cp = me.trackData.cp

        var top = lib.env.os.isIOS ? '-0.28rem' : '-0.09rem'

        var div = document.createElement('div')
        div.style.cssText = [
          'position: absolute',
          'z-index:' + (me.id++),
          'height:' + (selData.height * cp) + 'px',
          'width:' + (selData.width * cp) + 'px',
          'left:' + ((selData.x - blockData.x) * cp) + 'px',
          'top:' + top
        ].join(';')
        div.innerHTML = '<img src="' + imgUrl + '" width="100%">'
        document.body.appendChild(div)
        if (callback) {
          callback(div)
        }
      })
    },
    /**
     * 跟踪元素并在上分创建图片DOM节点
     * @author shilin.zsl <shilin.zsl@alibaba-inc.com>
     * @date   2016-05-19
     * @param  {String}   sel      目标元素
     * @param  {String}   imgUrl   图片url
     * @param  {Function} callback 图片创建完成执行回调
     * @return {[type]}            [description]
     */
    trackDom: function(sel, imgUrl, callback) {
      var ele = document.querySelector("[sel='" + sel + "'] > img ")
      if (!ele) {
        PoplayerOperator.renderDom(sel, imgUrl, function(div) {
          div.setAttribute("sel", sel)
          ele = div
          if (callback) {
            callback(div)
          }
        })
      } else {
        ele.src = imgUrl
        if (callback) {
          callback(ele)
        }
      }
    },
    /**
     * 显示国旗
     * @author shilin.zsl <shilin.zsl@alibaba-inc.com>
     * @date   2016-05-19
     * @param  {String}   sel      国旗目标元素
     * @param  {String}   imgFlag  国旗图片url
     * @param  {Function} callback 渲染国旗成功回调
     * @return {[type]}            [description]
     */
    showFlag: function(sel, imgFlag, callback) {
      var me = this
      me.trackDom(sel, '')
      me.trackDom(sel, imgFlag, function(flag) {
        callback(flag)
      })
    },
    /**
     * 修正元素坐标
     * @author shilin.zsl <shilin.zsl@alibaba-inc.com>
     * @date   2016-05-19
     * @return {[type]}   [description]
     */
    correctPos: function() {
      var me = this
      var sels = [start].concat(icons)
      var cp = me.trackData.cp
      setTimeout(function() {
        me.getItemSize(block, function(tv) {
          if (typeof tv === 'string') {
            tv = JSON.parse(tv)
          }
          sels.forEach(function(sel, i) {
            me.getItemSize(sel, function(e) {
              if (typeof e === 'string') {
                e = JSON.parse(e)
              }
              var dom = document.querySelector('[sel="' + sel + '"]')
              if (dom) {
                dom.style.top = (e.y - tv.y) * cp + 'px'
              }
              // 同时修正小车
              if (i === 1) {
                me.moto.style.top = (e.y - tv.y) * cp + 'px'
              }

              // 最后一个 item 算完后，再重新倒计时订正
              // if (i === sels.length - 1 && !me.finished) {
              //   me.correctPos()
              // }
            })
          })
        })
      }, 500)
    },
    /**
     * 初始化icon跟踪路径数据
     * @author shilin.zsl <shilin.zsl@alibaba-inc.com>
     * @date   2016-05-19
     * @param  {Function} callback [description]
     * @return {[type]}            [description]
     */
    initTrackData: function(callback) {
      var me = this
      var trackData = {}
      me.getItemSize(block, function(tv) {
        // alert(JSON.stringify(tv))
        if (typeof tv === 'string') {
          tv = JSON.parse(tv)
        }
        trackData.block = tv

        var renderScreenWidth = document.documentElement.clientWidth
        trackData.cp = renderScreenWidth / tv.width

        var count = 0
        var sels = [].concat(icons).concat([start])
        sels.forEach(function(sel) {
          me.getItemSize(sel, function(e) {
            if (typeof e === 'string') {
              e = JSON.parse(e)
            }
            trackData[sel] = e
            count++
            if (count === icons.length) {
              me.trackData = trackData
              callback()
            }
          })
        })
      })
    }
  }

  /**
   * Poplayer布局跟踪，跟踪整一个GridView区块
   * @author shilin.zsl <shilin.zsl@alibaba-inc.com>
   * @date   2016-05-19
   * @param  {String}   block     目标视图区块
   * @param  {Function}   function 跟踪成功执行回调
   * @return {[type]}             [description]
   */
  PoplayerOperator.trackLayout(block, function() {
    PoplayerOperator.listen()
    PoplayerOperator.display()
      /**
       * 显示国旗元素
       * @author shilin.zsl <shilin.zsl@alibaba-inc.com>
       * @date   2016-05-19
       * @return {[type]}   [description]
       */
    function showFlag() {
      for (var i = 0; i < 9; i++) {
        PoplayerOperator.showFlag(icons[i], flagImg[i], function(flag) {})
      }
    }

    /**
     * 开始动画场景
     * @author shilin.zsl <shilin.zsl@alibaba-inc.com>
     * @date   2016-05-19
     * @return {[type]}   [description]
     */
    function startScene() {
      // 动画延迟基准
      var delay = 500
        // 渲染飞机动图
      PoplayerOperator.renderPlane(start, planeImg, function(plane) {
        setTimeout(function() {
            var self = this
            var container = document.getElementsByClassName('mui-icon-container')[0],
              elements = document.getElementsByClassName('element'),
              target = document.getElementById('target')
            container.classList.remove('hidden')
            var parabola = []
            for (var i = 0, len = elements.length; i < len; i++) {
              // 抛物线元素的的位置标记
              var ani = funParabola(elements[i], target).mark()
              parabola.push(ani)
                // alert('test')
            }
            // 抛物线运动
            for (var i = 0, len = parabola.length; i < len; i++) {
              var ele = elements[i]
              parabola[i].init(function() {
                  // 隐藏国旗元素
                  this.style.display = 'none'
                }.bind(ele))
                // 绑定CSS3缩放动画
              ele.style.webkitAnimation = 'flag' + ' 1.7s linear'
            }
          }, delay)
          // 替换飞机图
        setTimeout(function() {
          PoplayerOperator.renderPlane(start, planeBackImg, function(planeBack) {
            document.body.removeChild(plane)
            setTimeout(function() {
              document.body.removeChild(planeBack)
              window.WindVane.call('WVPopLayer', 'increaseReadTimes', {})
                // 关闭PopLayer
              window.WindVane.call('WVPopLayer', 'close', {})
            }, 1000)
          })
        }, delay + 1400)
      })
    }

    // 先把图片都预加载，再开始动画场景
    var preloadMap = {}
    var preloadCount = 0
      // 预加载图片的链接数组
    var imageUrls = [].concat(flagImg).concat([planeImg, planeBackImg, blankImg])

    function finishChecker() {
      if (preloadCount === imageUrls.length) {
        // PoplayerOperator.initTrackData(startScene)
        window.WindVane.call('WVPopLayer', 'close', {})
      }
    }
    /**
     * 图片预加载
     * @author shilin.zsl <shilin.zsl@alibaba-inc.com>
     * @date   2016-05-19
     * @param  {String}   url 图片url
     */
    function preloadImg(url) {
      var img = new Image

      img.onload = function() {
        preloadCount++
        img = null
        finishChecker()
      }
      img.onerror = function() {
        preloadMap[url]++
          img = null

        // 图片失败 3 次，则跳过
        if (preloadMap[url] <= 3) {
          preloadImg(url)
        } else {
          preloadCount++
          finishChecker()
        }
      }
      img.src = url
    }
    /**
     * 图片链接数组执行预加载
     * @author shilin.zsl <shilin.zsl@alibaba-inc.com>
     * @date   2016-05-19
     * @param  {[type]}   function(url [description]
     * @return {[type]}                [description]
     */
    imageUrls.map(function(url) {
      preloadMap[url] = 0
      return url
    }).forEach(function(url) {
      preloadImg(url)
    })
  })
  </script>
</body>

</html>
